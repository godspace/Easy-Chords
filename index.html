<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–∫–∫–æ—Ä–¥–æ–≤—ã–π —Å–µ–∫–≤–µ–Ω—Å–æ—Ä</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: white;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        .user-email {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .auth-btn {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .auth-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .sequencer-section {
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
        }
        
        .sequencer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .sequencer-controls {
            display: flex;
            gap: 8px;
            width: 100%;
            justify-content: space-between;
        }
        
        .control-btn {
            padding: 12px 0;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
            flex: 1;
            text-align: center;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-btn.active {
            background: rgba(255, 255, 255, 0.4);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }
        
        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .record-btn {
            background: rgba(255, 50, 50, 0.3);
        }
        
        .record-btn.active {
            background: rgba(255, 50, 50, 0.6);
        }
        
        .play-btn {
            background: rgba(50, 200, 50, 0.3);
        }
        
        .play-btn.active {
            background: rgba(50, 200, 50, 0.6);
        }
        
        .sequencer-display {
            height: 60px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            position: relative;
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            padding: 10px;
            display: flex;
            align-items: center;
        }
        
        .time-marker {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #ff4444;
            z-index: 10;
            display: none;
        }
        
        .chord-block {
            display: inline-block;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            position: relative;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.2);
            transition: transform 0.1s;
            margin-right: 2px;
        }
        
        .chord-block.active {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.7);
            z-index: 5;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        .action-btn {
            flex: 1;
            padding: 12px 5px;
            background: rgba(255, 255, 255, 0.15);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .action-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }
        
        .action-btn:active {
            transform: scale(0.98);
        }
        
        .action-btn i {
            font-size: 1.2rem;
        }
        
        .action-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .action-btn.disabled:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .chord-row {
            margin-bottom: 15px;
        }
        
        .row-title {
            font-size: 1rem;
            margin-bottom: 8px;
            font-weight: 600;
            padding-left: 5px;
        }
        
        .chord-buttons {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        
        .chord-button {
            aspect-ratio: 1/1;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .chord-button:active {
            transform: scale(0.95);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .chord-button::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.1);
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .chord-button:active::after {
            opacity: 1;
        }
        
        .major { background: linear-gradient(135deg, #4CAF50, #2E7D32); }
        .minor { background: linear-gradient(135deg, #2196F3, #1565C0); }
        .major7 { background: linear-gradient(135deg, #FF9800, #EF6C00); }
        .minor7 { background: linear-gradient(135deg, #9C27B0, #6A1B9A); }
        
        .info {
            margin-top: 20px;
            text-align: center;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .settings-panel {
            margin-top: 15px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
        }
        
        .setting-group {
            margin-bottom: 15px;
        }
        
        .setting-group:last-child {
            margin-bottom: 0;
        }
        
        .setting-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .setting-name {
            font-weight: 500;
        }
        
        .setting-value {
            opacity: 0.8;
        }
        
        .slider {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            outline: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .waveform-selector {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .waveform-btn {
            flex: 1;
            padding: 8px 5px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            color: white;
            cursor: pointer;
            text-align: center;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        .waveform-btn.active {
            background: rgba(255, 255, 255, 0.3);
            border-color: white;
        }
        
        .timer {
            text-align: center;
            margin-top: 10px;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            color: white;
            text-align: center;
        }
        
        .modal h2 {
            margin-bottom: 15px;
        }
        
        .modal p {
            margin-bottom: 20px;
            opacity: 0.8;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .modal-btn.primary {
            background: rgba(50, 150, 250, 0.6);
        }
        
        .modal-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        
        .auth-input {
            padding: 12px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }
        
        .auth-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .gallery-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .gallery-info {
            flex: 1;
        }
        
        .gallery-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .gallery-author {
            font-size: 0.8rem;
            opacity: 0.7;
        }
        
        .gallery-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .like-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .liked {
            color: #ff4444;
        }
        
        .play-sequence-btn {
            padding: 8px 15px;
            background: rgba(50, 200, 50, 0.3);
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
        }
        
        @media (max-width: 400px) {
            .chord-button {
                font-size: 1rem;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .setting-label {
                font-size: 0.8rem;
            }
            
            .chord-block {
                width: 35px;
                height: 35px;
            }
            
            .control-btn {
                padding: 10px 0;
                font-size: 0.9rem;
                min-height: 45px;
            }
            
            .action-btn {
                font-size: 0.8rem;
                padding: 10px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="user-info">
            <div class="user-email" id="user-email">–ì–æ—Å—Ç—å</div>
            <button class="auth-btn" id="auth-btn">–í–æ–π—Ç–∏</button>
        </div>
        
        <h1>–ê–∫–∫–æ—Ä–¥–æ–≤—ã–π —Å–µ–∫–≤–µ–Ω—Å–æ—Ä</h1>
        
        <div class="sequencer-section">
            <div class="sequencer-header">
                <div class="sequencer-controls">
                    <button id="record-btn" class="control-btn record-btn">–ó–∞–ø–∏—Å—å</button>
                    <button id="play-stop-btn" class="control-btn play-btn" disabled>–ü—É—Å–∫</button>
                    <button id="clear-btn" class="control-btn">–û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
            </div>
            <div class="timer" id="timer">00:00 / 01:00</div>
            <div class="sequencer-display" id="sequencer-display">
                <div class="time-marker" id="time-marker"></div>
                <!-- –ó–∞–ø–∏—Å–∞–Ω–Ω—ã–µ –∞–∫–∫–æ—Ä–¥—ã –±—É–¥—É—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
            </div>
        </div>
        
        <div class="action-buttons">
            <button id="download-btn" class="action-btn">
                <i>‚Üì</i>
                <span>–°–∫–∞—á–∞—Ç—å WAV</span>
            </button>
            <button id="share-btn" class="action-btn disabled">
                <i>‚Üó</i>
                <span>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</span>
            </button>
            <button id="gallery-btn" class="action-btn">
                <i>üñºÔ∏è</i>
                <span>–ì–∞–ª–µ—Ä–µ—è</span>
            </button>
        </div>
        
        <div class="chord-row">
            <div class="row-title">–ú–∞–∂–æ—Ä–Ω—ã–µ</div>
            <div class="chord-buttons">
                <button class="chord-button major">–¥–æ</button>
                <button class="chord-button major">—Ä–µ</button>
                <button class="chord-button major">–º–∏</button>
                <button class="chord-button major">—Ñ–∞</button>
                <button class="chord-button major">—Å–æ–ª—å</button>
                <button class="chord-button major">–ª—è</button>
                <button class="chord-button major">—Å–∏</button>
            </div>
        </div>
        
        <div class="chord-row">
            <div class="row-title">–ú–∏–Ω–æ—Ä–Ω—ã–µ</div>
            <div class="chord-buttons">
                <button class="chord-button minor">–¥–æ</button>
                <button class="chord-button minor">—Ä–µ</button>
                <button class="chord-button minor">–º–∏</button>
                <button class="chord-button minor">—Ñ–∞</button>
                <button class="chord-button minor">—Å–æ–ª—å</button>
                <button class="chord-button minor">–ª—è</button>
                <button class="chord-button minor">—Å–∏</button>
            </div>
        </div>
        
        <div class="chord-row">
            <div class="row-title">–ú–∞–∂–æ—Ä–Ω—ã–µ —Å–µ–ø—Ç–∞–∫–∫–æ—Ä–¥—ã</div>
            <div class="chord-buttons">
                <button class="chord-button major7">–¥–æ</button>
                <button class="chord-button major7">—Ä–µ</button>
                <button class="chord-button major7">–º–∏</button>
                <button class="chord-button major7">—Ñ–∞</button>
                <button class="chord-button major7">—Å–æ–ª—å</button>
                <button class="chord-button major7">–ª—è</button>
                <button class="chord-button major7">—Å–∏</button>
            </div>
        </div>
        
        <div class="chord-row">
            <div class="row-title">–ú–∏–Ω–æ—Ä–Ω—ã–µ —Å–µ–ø—Ç–∞–∫–∫–æ—Ä–¥—ã</div>
            <div class="chord-buttons">
                <button class="chord-button minor7">–¥–æ</button>
                <button class="chord-button minor7">—Ä–µ</button>
                <button class="chord-button minor7">–º–∏</button>
                <button class="chord-button minor7">—Ñ–∞</button>
                <button class="chord-button minor7">—Å–æ–ª—å</button>
                <button class="chord-button minor7">–ª—è</button>
                <button class="chord-button minor7">—Å–∏</button>
            </div>
        </div>
        
        <div class="settings-panel">
            <div class="setting-group">
                <div class="setting-label">
                    <span class="setting-name">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</span>
                    <span class="setting-value" id="duration-value">2.0—Å</span>
                </div>
                <input type="range" class="slider" id="duration" min="5" max="50" value="20">
            </div>
            
            <div class="setting-group">
                <div class="setting-label">
                    <span class="setting-name">–†–µ–≤–µ—Ä–±–µ—Ä–∞—Ü–∏—è</span>
                    <span class="setting-value" id="reverb-value">50%</span>
                </div>
                <input type="range" class="slider" id="reverb" min="0" max="100" value="50">
            </div>
            
            <div class="setting-group">
                <div class="setting-label">
                    <span class="setting-name">–Ø—Ä–∫–æ—Å—Ç—å (—Ñ–∏–ª—å—Ç—Ä)</span>
                    <span class="setting-value" id="brightness-value">70%</span>
                </div>
                <input type="range" class="slider" id="brightness" min="0" max="100" value="70">
            </div>
            
            <div class="setting-group">
                <div class="setting-label">
                    <span class="setting-name">–î–µ—Ç–æ–Ω–∞—Ü–∏—è</span>
                    <span class="setting-value" id="detune-value">8—Ü</span>
                </div>
                <input type="range" class="slider" id="detune" min="0" max="20" value="8">
            </div>
            
            <div class="setting-group">
                <div class="setting-label">
                    <span class="setting-name">–í—ã—Å–æ—Ç–∞ —Ç–æ–Ω–∞</span>
                    <span class="setting-value" id="pitch-value">0—Ü</span>
                </div>
                <input type="range" class="slider" id="pitch" min="-1200" max="1200" value="0">
            </div>
            
            <div class="setting-group">
                <div class="setting-label">
                    <span class="setting-name">–¢–∏–ø –≤–æ–ª–Ω—ã</span>
                </div>
                <div class="waveform-selector">
                    <button class="waveform-btn active" data-wave="sine">–°–∏–Ω—É—Å</button>
                    <button class="waveform-btn" data-wave="triangle">–¢—Ä–µ—É–≥–æ–ª—å.</button>
                    <button class="waveform-btn" data-wave="sawtooth">–ü–∏–ª–∞</button>
                    <button class="waveform-btn" data-wave="square">–ü—Ä—è–º–æ—É–≥.</button>
                </div>
            </div>
        </div>
        
        <div class="info">
            –ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø–∏—Å—å", –∑–∞—Ç–µ–º –∏–≥—Ä–∞–π—Ç–µ –∞–∫–∫–æ—Ä–¥—ã. –ó–∞–ø–∏—Å—å –Ω–∞—á–Ω–µ—Ç—Å—è —Å –ø–µ—Ä–≤–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è.
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div id="auth-modal" class="modal">
        <div class="modal-content">
            <h2>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <div class="auth-form">
                <input type="email" id="auth-email" class="auth-input" placeholder="Email">
                <input type="password" id="auth-password" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
                <div class="modal-buttons">
                    <button class="modal-btn" id="close-auth">–ó–∞–∫—Ä—ã—Ç—å</button>
                    <button class="modal-btn primary" id="login-btn">–í–æ–π—Ç–∏</button>
                    <button class="modal-btn" id="register-btn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="share-modal" class="modal">
        <div class="modal-content">
            <h2>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å–µ–∫–≤–µ–Ω—Ü–∏–µ–π</h2>
            <p>–î–∞–π—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–π —Å–µ–∫–≤–µ–Ω—Ü–∏–∏, —á—Ç–æ–±—ã –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –µ—é —Å –¥—Ä—É–≥–∏–º–∏.</p>
            <div class="auth-form">
                <input type="text" id="sequence-title" class="auth-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ–∫–≤–µ–Ω—Ü–∏–∏">
                <div class="modal-buttons">
                    <button class="modal-btn" id="close-share">–ó–∞–∫—Ä—ã—Ç—å</button>
                    <button class="modal-btn primary" id="save-sequence-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="gallery-modal" class="modal">
        <div class="modal-content">
            <h2>–ì–∞–ª–µ—Ä–µ—è —Å–µ–∫–≤–µ–Ω—Ü–∏–π</h2>
            <div id="gallery-content">
                <!-- –°–µ–∫–≤–µ–Ω—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
            </div>
            <div class="modal-buttons">
                <button class="modal-btn" id="close-gallery">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase —Å –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        const supabaseUrl = 'https://pvapbcbgerpdojqnuqlm.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2YXBiY2JnZXJwZG9qcW51cWxtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNzc4OTAsImV4cCI6MjA3ODY1Mzg5MH0.cRdBJCw-lWSvgI2ZpUqUONc_AMP79ZKvKCOFsC5ti6c';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // –°–æ–∑–¥–∞–µ–º –∞—É–¥–∏–æ–∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–≤—É–∫–æ–≤
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioContext = new AudioContext();
        
        // –°–æ–∑–¥–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã
        const convolver = audioContext.createConvolver();
        const masterGain = audioContext.createGain();
        const compressor = audioContext.createDynamicsCompressor();
        const filter = audioContext.createBiquadFilter();
        const reverbGain = audioContext.createGain();
        const dryGain = audioContext.createGain();
        const limiter = audioContext.createDynamicsCompressor();
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–ø—Ä–µ—Å—Å–æ—Ä–∞ –¥–ª—è –±–æ–ª–µ–µ –ø–ª–∞–≤–Ω–æ–≥–æ –∑–≤—É–∫–∞
        compressor.threshold.setValueAtTime(-24, audioContext.currentTime);
        compressor.knee.setValueAtTime(30, audioContext.currentTime);
        compressor.ratio.setValueAtTime(12, audioContext.currentTime);
        compressor.attack.setValueAtTime(0.003, audioContext.currentTime);
        compressor.release.setValueAtTime(0.25, audioContext.currentTime);
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏–º–∏—Ç–µ—Ä–∞ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–ª–∏–ø–ø–∏–Ω–≥–∞
        limiter.threshold.setValueAtTime(-3.0, audioContext.currentTime);
        limiter.knee.setValueAtTime(0, audioContext.currentTime);
        limiter.ratio.setValueAtTime(20, audioContext.currentTime);
        limiter.attack.setValueAtTime(0.001, audioContext.currentTime);
        limiter.release.setValueAtTime(0.05, audioContext.currentTime);
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        filter.type = 'lowpass';
        filter.frequency.value = 3000;
        filter.Q.value = 1;
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥—Ä–æ–º–∫–æ—Å—Ç–∏
        masterGain.gain.value = 0.5;
        dryGain.gain.value = 1.0;
        reverbGain.gain.value = 0.5;
        
        // –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ü–µ–ø–æ—á–∫—É —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
        masterGain.connect(filter);
        filter.connect(dryGain);
        filter.connect(convolver);
        convolver.connect(reverbGain);
        dryGain.connect(compressor);
        reverbGain.connect(compressor);
        compressor.connect(limiter);
        limiter.connect(audioContext.destination);
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        let settings = {
            duration: 2.0,
            reverb: 0.5,
            brightness: 0.7,
            detune: 8,
            pitch: 0, // –í—ã—Å–æ—Ç–∞ —Ç–æ–Ω–∞ –≤ —Ü–µ–Ω—Ç–∞—Ö (100 —Ü–µ–Ω—Ç–æ–≤ = 1 –ø–æ–ª—É—Ç–æ–Ω)
            waveform: 'sine'
        };
        
        // –°–µ–∫–≤–µ–Ω—Å–æ—Ä
        let isRecording = false;
        let isWaitingForFirstChord = false;
        let isPlaying = false;
        let recordedSequence = [];
        let recordingStartTime = 0;
        let playTimeouts = [];
        let playStartTime = 0;
        let recordingTimer = null;
        let recordingDuration = 0;
        const MAX_RECORDING_TIME = 60000; // 1 –º–∏–Ω—É—Ç–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
        
        // –ê–∫—Ç–∏–≤–Ω—ã–µ –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª–∏—Ñ–æ–Ω–∏–µ–π
        let activeOscillators = [];
        const MAX_POLYPHONY = 20; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∑–≤—É—á–∞—â–∏—Ö –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä–æ–≤
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ–∫–≤–µ–Ω—Å–æ—Ä–æ–º
        const recordBtn = document.getElementById('record-btn');
        const playStopBtn = document.getElementById('play-stop-btn');
        const clearBtn = document.getElementById('clear-btn');
        const sequencerDisplay = document.getElementById('sequencer-display');
        const timeMarker = document.getElementById('time-marker');
        const timerElement = document.getElementById('timer');
        
        // –ù–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
        const downloadBtn = document.getElementById('download-btn');
        const shareBtn = document.getElementById('share-btn');
        const galleryBtn = document.getElementById('gallery-btn');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        const authBtn = document.getElementById('auth-btn');
        const userEmail = document.getElementById('user-email');
        
        // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
        const authModal = document.getElementById('auth-modal');
        const shareModal = document.getElementById('share-modal');
        const galleryModal = document.getElementById('gallery-modal');
        const closeAuthBtn = document.getElementById('close-auth');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const closeShareBtn = document.getElementById('close-share');
        const saveSequenceBtn = document.getElementById('save-sequence-btn');
        const closeGalleryBtn = document.getElementById('close-gallery');
        const galleryContent = document.getElementById('gallery-content');
        
        // –ü–æ–ª—è —Ñ–æ—Ä–º
        const authEmail = document.getElementById('auth-email');
        const authPassword = document.getElementById('auth-password');
        const sequenceTitle = document.getElementById('sequence-title');
        
        // –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        let currentUser = null;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        checkAuthState();
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        async function checkAuthState() {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                currentUser = user;
                userEmail.textContent = user.email;
                authBtn.textContent = '–í—ã–π—Ç–∏';
                shareBtn.classList.remove('disabled');
            } else {
                currentUser = null;
                userEmail.textContent = '–ì–æ—Å—Ç—å';
                authBtn.textContent = '–í–æ–π—Ç–∏';
                shareBtn.classList.add('disabled');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—Ö–æ–¥–∞
        async function signIn(email, password) {
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            });
            
            if (error) {
                alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
                return false;
            }
            
            currentUser = data.user;
            userEmail.textContent = data.user.email;
            authBtn.textContent = '–í—ã–π—Ç–∏';
            shareBtn.classList.remove('disabled');
            authModal.style.display = 'none';
            return true;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        async function signUp(email, password) {
            const { data, error } = await supabase.auth.signUp({
                email: email,
                password: password,
            });
            
            if (error) {
                alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message);
                return false;
            }
            
            alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏.');
            return true;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—Ö–æ–¥–∞
        async function signOut() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                alert('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: ' + error.message);
                return;
            }
            
            currentUser = null;
            userEmail.textContent = '–ì–æ—Å—Ç—å';
            authBtn.textContent = '–í–æ–π—Ç–∏';
            shareBtn.classList.add('disabled');
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ–∫–≤–µ–Ω—Ü–∏–∏
        async function saveSequence(title) {
            if (!currentUser) {
                alert('–î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ–∫–≤–µ–Ω—Ü–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É');
                return false;
            }
            
            if (recordedSequence.length === 0) {
                alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø–∏—à–∏—Ç–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–∫–∫–æ—Ä–¥–æ–≤');
                return false;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏ –ª–∏–º–∏—Ç –≤ 3 —Å–µ–∫–≤–µ–Ω—Ü–∏–∏
            const { data: userSequences, error: countError } = await supabase
                .from('sequences')
                .select('id')
                .eq('user_id', currentUser.id);
                
            if (countError) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ª–∏–º–∏—Ç–∞: ' + countError.message);
                return false;
            }
            
            if (userSequences && userSequences.length >= 3) {
                alert('–í—ã –º–æ–∂–µ—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ 3 —Å–µ–∫–≤–µ–Ω—Ü–∏–∏. –£–¥–∞–ª–∏—Ç–µ –æ–¥–Ω—É –∏–∑ —Å—Ç–∞—Ä—ã—Ö, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤—É—é.');
                return false;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ–∫–≤–µ–Ω—Ü–∏—é
            const { data, error } = await supabase
                .from('sequences')
                .insert([
                    { 
                        user_id: currentUser.id, 
                        title: title,
                        sequence_data: recordedSequence,
                        settings: settings
                    }
                ])
                .select();
                
            if (error) {
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
                return false;
            }
            
            alert('–°–µ–∫–≤–µ–Ω—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
            shareModal.style.display = 'none';
            return true;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≥–∞–ª–µ—Ä–µ–∏
        async function loadGallery() {
            const { data: sequences, error } = await supabase
                .from('sequences')
                .select(`
                    id,
                    title,
                    sequence_data,
                    settings,
                    likes,
                    user_id,
                    profiles:user_id (email)
                `)
                .order('created_at', { ascending: false });
                
            if (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–∞–ª–µ—Ä–µ–∏:', error);
                galleryContent.innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–∞–ª–µ—Ä–µ–∏</p>';
                return;
            }
            
            if (!sequences || sequences.length === 0) {
                galleryContent.innerHTML = '<p>–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Å–µ–∫–≤–µ–Ω—Ü–∏–π</p>';
                return;
            }
            
            galleryContent.innerHTML = '';
            
            sequences.forEach(seq => {
                const galleryItem = document.createElement('div');
                galleryItem.className = 'gallery-item';
                
                const isLikedByUser = currentUser && seq.liked_by && seq.liked_by.includes(currentUser.id);
                
                galleryItem.innerHTML = `
                    <div class="gallery-info">
                        <div class="gallery-title">${seq.title}</div>
                        <div class="gallery-author">–ê–≤—Ç–æ—Ä: ${seq.profiles.email}</div>
                    </div>
                    <div class="gallery-actions">
                        <button class="like-btn ${isLikedByUser ? 'liked' : ''}" data-id="${seq.id}">
                            ‚ô• <span>${seq.likes || 0}</span>
                        </button>
                        <button class="play-sequence-btn" data-id="${seq.id}">‚ñ∂</button>
                    </div>
                `;
                
                galleryContent.appendChild(galleryItem);
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –ª–∞–π–∫–æ–≤ –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
            document.querySelectorAll('.like-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    if (!currentUser) {
                        alert('–î–ª—è –æ—Ü–µ–Ω–∫–∏ —Å–µ–∫–≤–µ–Ω—Ü–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É');
                        return;
                    }
                    
                    const sequenceId = this.getAttribute('data-id');
                    await toggleLike(sequenceId, this);
                });
            });
            
            document.querySelectorAll('.play-sequence-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const sequenceId = this.getAttribute('data-id');
                    const sequence = sequences.find(s => s.id == sequenceId);
                    if (sequence) {
                        playSequenceFromData(sequence.sequence_data, sequence.settings);
                    }
                });
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–∞–π–∫–∞/–∞–Ω–ª–∞–π–∫–∞
        async function toggleLike(sequenceId, likeBtn) {
            const { data: sequence, error } = await supabase
                .from('sequences')
                .select('likes, liked_by')
                .eq('id', sequenceId)
                .single();
                
            if (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö —Å–µ–∫–≤–µ–Ω—Ü–∏–∏:', error);
                return;
            }
            
            const currentLikes = sequence.likes || 0;
            const likedBy = sequence.liked_by || [];
            const isLiked = likedBy.includes(currentUser.id);
            
            let newLikes;
            let newLikedBy;
            
            if (isLiked) {
                // –£–±–∏—Ä–∞–µ–º –ª–∞–π–∫
                newLikes = Math.max(0, currentLikes - 1);
                newLikedBy = likedBy.filter(id => id !== currentUser.id);
                likeBtn.classList.remove('liked');
            } else {
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–∞–π–∫
                newLikes = currentLikes + 1;
                newLikedBy = [...likedBy, currentUser.id];
                likeBtn.classList.add('liked');
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –ª–∞–π–∫–æ–≤
            likeBtn.querySelector('span').textContent = newLikes;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –±–∞–∑–µ
            const { error: updateError } = await supabase
                .from('sequences')
                .update({ 
                    likes: newLikes,
                    liked_by: newLikedBy
                })
                .eq('id', sequenceId);
                
            if (updateError) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ª–∞–π–∫–æ–≤:', updateError);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è —Å–µ–∫–≤–µ–Ω—Ü–∏–∏ –∏–∑ –¥–∞–Ω–Ω—ã—Ö
        function playSequenceFromData(sequenceData, sequenceSettings) {
            if (isPlaying) {
                stopPlayback();
            }
            
            // –í—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ–∫–≤–µ–Ω—Ü–∏–∏
            const originalSettings = { ...settings };
            if (sequenceSettings) {
                Object.keys(sequenceSettings).forEach(key => {
                    if (settings.hasOwnProperty(key)) {
                        settings[key] = sequenceSettings[key];
                    }
                });
                updateSlidersFromSettings();
            }
            
            // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º —Å–µ–∫–≤–µ–Ω—Ü–∏—é
            const tempSequence = [...sequenceData];
            recordedSequence = tempSequence;
            
            // –û—á–∏—â–∞–µ–º –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            sequencerDisplay.innerHTML = '<div class="time-marker" id="time-marker"></div>';
            tempSequence.forEach((chord, index) => {
                addChordBlockToSequencer(chord.note, chord.chordType);
            });
            
            playSequence();
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
            setTimeout(() => {
                settings = originalSettings;
                updateSlidersFromSettings();
            }, (tempSequence[tempSequence.length - 1].timeOffset || 0) + settings.duration * 1000 + 1000);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ª–∞–π–¥–µ—Ä–æ–≤ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        function updateSlidersFromSettings() {
            document.getElementById('duration').value = settings.duration * 10;
            document.getElementById('reverb').value = settings.reverb * 100;
            document.getElementById('brightness').value = settings.brightness * 100;
            document.getElementById('detune').value = settings.detune;
            document.getElementById('pitch').value = settings.pitch;
            
            document.getElementById('duration-value').textContent = settings.duration.toFixed(1) + '—Å';
            document.getElementById('reverb-value').textContent = Math.round(settings.reverb * 100) + '%';
            document.getElementById('brightness-value').textContent = Math.round(settings.brightness * 100) + '%';
            document.getElementById('detune-value').textContent = settings.detune + '—Ü';
            document.getElementById('pitch-value').textContent = settings.pitch + '—Ü';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –≤–æ–ª–Ω—ã
            document.querySelectorAll('.waveform-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.wave === settings.waveform) {
                    btn.classList.add('active');
                }
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–º–ø—É–ª—å—Å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è —Ä–µ–≤–µ—Ä–±–µ—Ä–∞—Ü–∏–∏
        function createReverbBuffer(audioContext, duration = 2.0) {
            const length = audioContext.sampleRate * duration;
            const buffer = audioContext.createBuffer(2, length, audioContext.sampleRate);
            const dataL = buffer.getChannelData(0);
            const dataR = buffer.getChannelData(1);
            
            for (let i = 0; i < length; i++) {
                // –°–æ–∑–¥–∞–µ–º –±–æ–ª–µ–µ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—É—é —Ä–µ–≤–µ—Ä–±–µ—Ä–∞—Ü–∏—é —Å —Ä–∞–Ω–Ω–∏–º–∏ –æ—Ç—Ä–∞–∂–µ–Ω–∏—è–º–∏
                const decay = Math.pow(1 - i / length, 2);
                const earlyReflections = (i < length * 0.1) ? 1.5 : 1.0;
                const noise = (Math.random() * 2 - 1) * decay * earlyReflections;
                
                dataL[i] = noise;
                dataR[i] = noise * 0.7; // –ù–µ–±–æ–ª—å—à–∞—è —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É –∫–∞–Ω–∞–ª–∞–º–∏ –¥–ª—è —Å—Ç–µ—Ä–µ–æ-—ç—Ñ—Ñ–µ–∫—Ç–∞
            }
            
            return buffer;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ WAV —Å –≤—ã—Å–æ–∫–∏–º –∫–∞—á–µ—Å—Ç–≤–æ–º
        async function renderToWAV() {
            if (recordedSequence.length === 0) {
                alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø–∏—à–∏—Ç–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–∫–∫–æ—Ä–¥–æ–≤');
                return;
            }
            
            try {
                // –°–æ–∑–¥–∞–µ–º OfflineAudioContext –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Å –≤—ã—Å–æ–∫–∏–º –∫–∞—á–µ—Å—Ç–≤–æ–º
                const sampleRate = 44100;
                const offlineCtx = new OfflineAudioContext({
                    numberOfChannels: 2,
                    length: sampleRate * (recordedSequence[recordedSequence.length - 1].timeOffset / 1000 + settings.duration + 2),
                    sampleRate: sampleRate,
                });
                
                // –°–æ–∑–¥–∞–µ–º –ø–æ–ª–Ω—É—é —Ü–µ–ø–æ—á–∫—É —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –¥–ª—è offline –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
                const offlineConvolver = offlineCtx.createConvolver();
                const offlineMasterGain = offlineCtx.createGain();
                const offlineCompressor = offlineCtx.createDynamicsCompressor();
                const offlineFilter = offlineCtx.createBiquadFilter();
                const offlineReverbGain = offlineCtx.createGain();
                const offlineDryGain = offlineCtx.createGain();
                const offlineLimiter = offlineCtx.createDynamicsCompressor();
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–ø—Ä–µ—Å—Å–æ—Ä–∞
                offlineCompressor.threshold.setValueAtTime(-24, offlineCtx.currentTime);
                offlineCompressor.knee.setValueAtTime(30, offlineCtx.currentTime);
                offlineCompressor.ratio.setValueAtTime(12, offlineCtx.currentTime);
                offlineCompressor.attack.setValueAtTime(0.003, offlineCtx.currentTime);
                offlineCompressor.release.setValueAtTime(0.25, offlineCtx.currentTime);
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏–º–∏—Ç–µ—Ä–∞
                offlineLimiter.threshold.setValueAtTime(-3.0, offlineCtx.currentTime);
                offlineLimiter.knee.setValueAtTime(0, offlineCtx.currentTime);
                offlineLimiter.ratio.setValueAtTime(20, offlineCtx.currentTime);
                offlineLimiter.attack.setValueAtTime(0.001, offlineCtx.currentTime);
                offlineLimiter.release.setValueAtTime(0.05, offlineCtx.currentTime);
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞
                offlineFilter.type = 'lowpass';
                offlineFilter.frequency.value = 500 + settings.brightness * 4500;
                offlineFilter.Q.value = 1;
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥—Ä–æ–º–∫–æ—Å—Ç–∏
                offlineMasterGain.gain.value = 0.5;
                offlineDryGain.gain.value = 1.0 - settings.reverb * 0.7;
                offlineReverbGain.gain.value = settings.reverb;
                
                // –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ü–µ–ø–æ—á–∫—É —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
                offlineMasterGain.connect(offlineFilter);
                offlineFilter.connect(offlineDryGain);
                offlineFilter.connect(offlineConvolver);
                offlineConvolver.connect(offlineReverbGain);
                offlineDryGain.connect(offlineCompressor);
                offlineReverbGain.connect(offlineCompressor);
                offlineCompressor.connect(offlineLimiter);
                offlineLimiter.connect(offlineCtx.destination);
                
                // –°–æ–∑–¥–∞–µ–º –∏–º–ø—É–ª—å—Å–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è —Ä–µ–≤–µ—Ä–±–µ—Ä–∞—Ü–∏–∏
                const reverbBuffer = createReverbBuffer(offlineCtx, settings.duration * 1.5);
                offlineConvolver.buffer = reverbBuffer;
                
                // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ offline –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
                recordedSequence.forEach((chord) => {
                    const rootFreq = noteFrequencies[chord.note];
                    let frequencies;
                    
                    switch(chord.chordType) {
                        case 'major':
                            frequencies = getMajorChord(rootFreq);
                            break;
                        case 'minor':
                            frequencies = getMinorChord(rootFreq);
                            break;
                        case 'major7':
                            frequencies = getMajor7Chord(rootFreq);
                            break;
                        case 'minor7':
                            frequencies = getMinor7Chord(rootFreq);
                            break;
                    }
                    
                    // –°–æ–∑–¥–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–∫–∫–æ—Ä–¥–∞
                    frequencies.forEach((freq) => {
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—ã—Å–æ—Ç—ã —Ç–æ–Ω–∞
                        const pitchRatio = centsToRatio(settings.pitch);
                        const finalFreq = freq * pitchRatio;
                        
                        // –°–æ–∑–¥–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä
                        const mainOsc = offlineCtx.createOscillator();
                        mainOsc.frequency.value = finalFreq;
                        mainOsc.type = settings.waveform;
                        mainOsc.detune.value = settings.detune;
                        
                        // –°–æ–∑–¥–∞–µ–º –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä —Å –æ–∫—Ç–∞–≤–æ–π –≤—ã—à–µ –¥–ª—è –æ–±–µ—Ä—Ç–æ–Ω–æ–≤
                        const overtoneOsc = offlineCtx.createOscillator();
                        overtoneOsc.frequency.value = finalFreq * 2;
                        overtoneOsc.type = 'triangle';
                        overtoneOsc.detune.value = settings.detune;
                        
                        // –°–æ–∑–¥–∞–µ–º –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä —Å –∫–≤–∏–Ω—Ç–æ–π –¥–ª—è –æ–±–µ—Ä—Ç–æ–Ω–æ–≤
                        const fifthOsc = offlineCtx.createOscillator();
                        fifthOsc.frequency.value = finalFreq * 1.5;
                        fifthOsc.type = 'sine';
                        fifthOsc.detune.value = -settings.detune;
                        
                        // –°–æ–∑–¥–∞–µ–º —É–∑–ª—ã –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä–∞
                        const mainGain = offlineCtx.createGain();
                        const overtoneGain = offlineCtx.createGain();
                        const fifthGain = offlineCtx.createGain();
                        
                        // –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –≥—Ä–æ–º–∫–æ—Å—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –Ω–æ—Ç
                        const adaptiveGain = 1 / Math.sqrt(frequencies.length);
                        mainGain.gain.value = 0.1 * adaptiveGain;
                        overtoneGain.gain.value = 0.03 * adaptiveGain;
                        fifthGain.gain.value = 0.02 * adaptiveGain;
                        
                        // –ü–æ–¥–∫–ª—é—á–∞–µ–º –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä—ã
                        mainOsc.connect(mainGain);
                        overtoneOsc.connect(overtoneGain);
                        fifthOsc.connect(fifthGain);
                        
                        // –ü–æ–¥–∫–ª—é—á–∞–µ–º –≤—Å–µ –∫ –º–∞—Å—Ç–µ—Ä-—É—Å–∏–ª–∏—Ç–µ–ª—é
                        mainGain.connect(offlineMasterGain);
                        overtoneGain.connect(offlineMasterGain);
                        fifthGain.connect(offlineMasterGain);
                        
                        // –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä—ã
                        const startTime = chord.timeOffset / 1000;
                        mainOsc.start(startTime);
                        overtoneOsc.start(startTime);
                        fifthOsc.start(startTime);
                        
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º ADSR-–æ–≥–∏–±–∞—é—â—É—é —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
                        createOfflineADSR(mainGain, startTime, settings.duration, 0.05, 0.2, 0.7, 0.5);
                        createOfflineADSR(overtoneGain, startTime, settings.duration, 0.05, 0.2, 0.5, 0.5);
                        createOfflineADSR(fifthGain, startTime, settings.duration, 0.05, 0.2, 0.3, 0.5);
                        
                        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä—ã
                        const stopTime = startTime + settings.duration + 0.5;
                        mainOsc.stop(stopTime);
                        overtoneOsc.stop(stopTime);
                        fifthOsc.stop(stopTime);
                    });
                });
                
                // –†–µ–Ω–¥–µ—Ä–∏–º –∞—É–¥–∏–æ
                const renderedBuffer = await offlineCtx.startRendering();
                
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ WAV —Å –≤—ã—Å–æ–∫–∏–º –∫–∞—á–µ—Å—Ç–≤–æ–º
                const wavBlob = bufferToWav(renderedBuffer);
                
                // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                const url = URL.createObjectURL(wavBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sequence_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.wav`;
                a.click();
                
                // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–∞–º—è—Ç—å
                setTimeout(() => URL.revokeObjectURL(url), 1000);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ WAV —Ñ–∞–π–ª–∞: ' + error.message);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è ADSR –≤ offline –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
        function createOfflineADSR(gainNode, startTime, duration, attack = 0.05, decay = 0.2, sustain = 0.7, release = 0.5) {
            const totalDuration = duration;
            const sustainDuration = totalDuration - (attack + decay + release);
            
            gainNode.gain.setValueAtTime(0, startTime);
            gainNode.gain.linearRampToValueAtTime(1, startTime + attack);
            gainNode.gain.linearRampToValueAtTime(sustain, startTime + attack + decay);
            gainNode.gain.linearRampToValueAtTime(sustain, startTime + attack + decay + Math.max(0, sustainDuration));
            gainNode.gain.linearRampToValueAtTime(0, startTime + attack + decay + Math.max(0, sustainDuration) + release);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ AudioBuffer –≤ WAV Blob —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –∫–∞—á–µ—Å—Ç–≤–æ–º
        function bufferToWav(buffer) {
            const numOfChan = buffer.numberOfChannels;
            const length = buffer.length * numOfChan * 2 + 44;
            const bufferArray = new ArrayBuffer(length);
            const view = new DataView(bufferArray);
            const channels = [];
            let offset = 0;
            let pos = 0;
            
            // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º WAV –∑–∞–≥–æ–ª–æ–≤–æ–∫
            setUint32(0x46464952); // "RIFF"
            setUint32(length - 8); // file length - 8
            setUint32(0x45564157); // "WAVE"
            setUint32(0x20746d66); // "fmt " chunk
            setUint32(16); // length = 16
            setUint16(1); // PCM (uncompressed)
            setUint16(numOfChan);
            setUint32(buffer.sampleRate);
            setUint32(buffer.sampleRate * 2 * numOfChan); // avg. bytes/sec
            setUint16(numOfChan * 2); // block-align
            setUint16(16); // 16-bit
            setUint32(0x61746164); // "data" - chunk
            setUint32(length - pos - 4); // chunk length
            
            // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª–æ–≤ —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π
            for (let i = 0; i < buffer.numberOfChannels; i++) {
                channels.push(buffer.getChannelData(i));
            }
            
            // –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
            let maxVal = 0;
            for (let i = 0; i < buffer.length; i++) {
                for (let channel = 0; channel < numOfChan; channel++) {
                    const val = Math.abs(channels[channel][i]);
                    if (val > maxVal) maxVal = val;
                }
            }
            
            // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            const normalizeFactor = maxVal > 0 ? 0.99 / maxVal : 1; // –û—Å—Ç–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–ø–∞—Å
            offset = 0;
            
            while (pos < length - 44) {
                for (let channel = 0; channel < numOfChan; channel++) {
                    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
                    let sample = Math.max(-1, Math.min(1, channels[channel][offset] * normalizeFactor));
                    sample = sample < 0 ? sample * 32768 : sample * 32767;
                    view.setInt16(pos + channel * 2, sample, true);
                }
                pos += numOfChan * 2;
                offset++;
            }
            
            // –°–æ–∑–¥–∞–µ–º Blob
            return new Blob([bufferArray], { type: 'audio/wav' });
            
            function setUint16(data) {
                view.setUint16(pos, data, true);
                pos += 2;
            }
            
            function setUint32(data) {
                view.setUint32(pos, data, true);
                pos += 4;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Ü–µ–Ω—Ç–æ–≤ –≤ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —á–∞—Å—Ç–æ—Ç—ã
        function centsToRatio(cents) {
            return Math.pow(2, cents / 1200);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä–∞ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –∑–≤—É–∫–æ–º
        function createOscillator(frequency, type = settings.waveform, detune = settings.detune) {
            const oscillator = audioContext.createOscillator();
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É –≤—ã—Å–æ—Ç—ã —Ç–æ–Ω–∞
            const pitchRatio = centsToRatio(settings.pitch);
            oscillator.frequency.value = frequency * pitchRatio;
            
            oscillator.type = type;
            oscillator.detune.value = detune; // –≤ —Ü–µ–Ω—Ç–∞—Ö
            
            return oscillator;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª–∏—Ñ–æ–Ω–∏–µ–π
        function managePolyphony() {
            // –ï—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä–æ–≤, –æ—Å—Ç–∞–Ω–æ–≤–∏–º —Å–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ
            while (activeOscillators.length > MAX_POLYPHONY) {
                const oldestOsc = activeOscillators.shift();
                if (oldestOsc) {
                    try {
                        oldestOsc.oscillator.stop();
                        oldestOsc.gainNode.disconnect();
                    } catch(e) {
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
                    }
                }
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è ADSR-–æ–≥–∏–±–∞—é—â–µ–π
        function createADSR(gainNode, startTime, duration, attack = 0.05, decay = 0.2, sustain = 0.7, release = 0.5) {
            const now = audioContext.currentTime;
            const totalDuration = duration;
            const sustainDuration = totalDuration - (attack + decay + release);
            
            gainNode.gain.cancelScheduledValues(now);
            gainNode.gain.setValueAtTime(0, now);
            
            // –ê—Ç–∞–∫–∞
            gainNode.gain.linearRampToValueAtTime(1, now + attack);
            
            // –°–ø–∞–¥
            gainNode.gain.linearRampToValueAtTime(sustain, now + attack + decay);
            
            // –°—É—Å—Ç–µ–π–Ω
            gainNode.gain.linearRampToValueAtTime(sustain, now + attack + decay + Math.max(0, sustainDuration));
            
            // –†–µ–ª–∏–∑
            gainNode.gain.linearRampToValueAtTime(0, now + attack + decay + Math.max(0, sustainDuration) + release);
            
            return now + attack + decay + Math.max(0, sustainDuration) + release;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏—è –∞–∫–∫–æ—Ä–¥–∞ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –∑–≤—É—á–∞–Ω–∏–µ–º
        function playChord(frequencies, duration = settings.duration, chordType = 'major') {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–≤–µ—Ä–±–µ—Ä–∞—Ü–∏—é –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π
            reverbGain.gain.value = settings.reverb;
            dryGain.gain.value = 1.0 - settings.reverb * 0.7;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π —è—Ä–∫–æ—Å—Ç–∏
            filter.frequency.value = 500 + settings.brightness * 4500;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–µ–≤–µ—Ä–±–µ—Ä–∞—Ü–∏–∏
            convolver.buffer = createReverbBuffer(audioContext, settings.duration * 1.5);
            
            // –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –≥—Ä–æ–º–∫–æ—Å—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –Ω–æ—Ç
            const adaptiveGain = 1 / Math.sqrt(frequencies.length);
            
            frequencies.forEach((freq, index) => {
                // –°–æ–∑–¥–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä
                const mainOsc = createOscillator(freq);
                const mainGain = audioContext.createGain();
                mainGain.gain.value = 0.1 * adaptiveGain;
                
                // –°–æ–∑–¥–∞–µ–º –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä —Å –æ–∫—Ç–∞–≤–æ–π –≤—ã—à–µ –¥–ª—è –æ–±–µ—Ä—Ç–æ–Ω–æ–≤
                const overtoneOsc = createOscillator(freq * 2, 'triangle', settings.detune);
                const overtoneGain = audioContext.createGain();
                overtoneGain.gain.value = 0.03 * adaptiveGain;
                
                // –°–æ–∑–¥–∞–µ–º –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä —Å –∫–≤–∏–Ω—Ç–æ–π –¥–ª—è –æ–±–µ—Ä—Ç–æ–Ω–æ–≤
                const fifthOsc = createOscillator(freq * 1.5, 'sine', -settings.detune);
                const fifthGain = audioContext.createGain();
                fifthGain.gain.value = 0.02 * adaptiveGain;
                
                // –ü–æ–¥–∫–ª—é—á–∞–µ–º –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä—ã
                mainOsc.connect(mainGain);
                overtoneOsc.connect(overtoneGain);
                fifthOsc.connect(fifthGain);
                
                // –ü–æ–¥–∫–ª—é—á–∞–µ–º –≤—Å–µ –∫ –º–∞—Å—Ç–µ—Ä-—É—Å–∏–ª–∏—Ç–µ–ª—é
                mainGain.connect(masterGain);
                overtoneGain.connect(masterGain);
                fifthGain.connect(masterGain);
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä—ã
                const startTime = audioContext.currentTime;
                mainOsc.start(startTime);
                overtoneOsc.start(startTime);
                fifthOsc.start(startTime);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∞–∫—Ç–∏–≤–Ω—ã–µ –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä—ã
                activeOscillators.push({oscillator: mainOsc, gainNode: mainGain});
                activeOscillators.push({oscillator: overtoneOsc, gainNode: overtoneGain});
                activeOscillators.push({oscillator: fifthOsc, gainNode: fifthGain});
                
                // –£–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª–∏—Ñ–æ–Ω–∏–µ–π
                managePolyphony();
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º ADSR-–æ–≥–∏–±–∞—é—â—É—é
                const stopTime = createADSR(mainGain, startTime, duration, 0.05, 0.2, 0.7, 0.5);
                createADSR(overtoneGain, startTime, duration, 0.05, 0.2, 0.5, 0.5);
                createADSR(fifthGain, startTime, duration, 0.05, 0.2, 0.3, 0.5);
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä—ã
                mainOsc.stop(stopTime);
                overtoneOsc.stop(stopTime);
                fifthOsc.stop(stopTime);
                
                // –£–¥–∞–ª—è–µ–º –∏–∑ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä–æ–≤ –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                setTimeout(() => {
                    activeOscillators = activeOscillators.filter(osc => 
                        osc.oscillator !== mainOsc && 
                        osc.oscillator !== overtoneOsc && 
                        osc.oscillator !== fifthOsc
                    );
                }, (stopTime - startTime) * 1000);
            });
        }
        
        // –ß–∞—Å—Ç–æ—Ç—ã –Ω–æ—Ç (–≤ –≥–µ—Ä—Ü–∞—Ö) –¥–ª—è –æ–∫—Ç–∞–≤—ã –æ—Ç C4 (–¥–æ) –¥–æ B4 (—Å–∏)
        const noteFrequencies = {
            '–¥–æ': 261.63,
            '—Ä–µ': 293.66,
            '–º–∏': 329.63,
            '—Ñ–∞': 349.23,
            '—Å–æ–ª—å': 392.00,
            '–ª—è': 440.00,
            '—Å–∏': 493.88
        };
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫–∫–æ—Ä–¥–æ–≤ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º–∏
        function getMajorChord(rootFreq) {
            return [
                rootFreq,                           // —Ç–æ–Ω–∏–∫–∞
                rootFreq * Math.pow(2, 4/12),      // –±–æ–ª—å—à–∞—è —Ç–µ—Ä—Ü–∏—è
                rootFreq * Math.pow(2, 7/12),      // –∫–≤–∏–Ω—Ç–∞
                rootFreq * 2                        // –æ–∫—Ç–∞–≤–∞ (–¥–ª—è –ø–æ–ª–Ω–æ—Ç—ã –∑–≤—É—á–∞–Ω–∏—è)
            ];
        }
        
        function getMinorChord(rootFreq) {
            return [
                rootFreq,                           // —Ç–æ–Ω–∏–∫–∞
                rootFreq * Math.pow(2, 3/12),      // –º–∞–ª–∞—è —Ç–µ—Ä—Ü–∏—è
                rootFreq * Math.pow(2, 7/12),      // –∫–≤–∏–Ω—Ç–∞
                rootFreq * 2                        // –æ–∫—Ç–∞–≤–∞ (–¥–ª—è –ø–æ–ª–Ω–æ—Ç—ã –∑–≤—É—á–∞–Ω–∏—è)
            ];
        }
        
        function getMajor7Chord(rootFreq) {
            return [
                rootFreq,                           // —Ç–æ–Ω–∏–∫–∞
                rootFreq * Math.pow(2, 4/12),      // –±–æ–ª—å—à–∞—è —Ç–µ—Ä—Ü–∏—è
                rootFreq * Math.pow(2, 7/12),      // –∫–≤–∏–Ω—Ç–∞
                rootFreq * Math.pow(2, 11/12)      // –±–æ–ª—å—à–∞—è —Å–µ–ø—Ç–∏–º–∞
            ];
        }
        
        function getMinor7Chord(rootFreq) {
            return [
                rootFreq,                           // —Ç–æ–Ω–∏–∫–∞
                rootFreq * Math.pow(2, 3/12),      // –º–∞–ª–∞—è —Ç–µ—Ä—Ü–∏—è
                rootFreq * Math.pow(2, 7/12),      // –∫–≤–∏–Ω—Ç–∞
                rootFreq * Math.pow(2, 10/12)      // –º–∞–ª–∞—è —Å–µ–ø—Ç–∏–º–∞
            ];
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
        function formatTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞ –∑–∞–ø–∏—Å–∏
        function updateRecordingTimer() {
            if (isRecording && recordingStartTime > 0) {
                recordingDuration = Date.now() - recordingStartTime;
                timerElement.textContent = `${formatTime(recordingDuration)} / ${formatTime(MAX_RECORDING_TIME)}`;
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –ø–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏
                if (recordingDuration >= MAX_RECORDING_TIME) {
                    stopRecording();
                }
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—á–∞–ª–∞ –∑–∞–ø–∏—Å–∏
        function startRecording() {
            isWaitingForFirstChord = true;
            recordBtn.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ...';
            recordBtn.classList.add('active');
            recordedSequence = [];
            sequencerDisplay.innerHTML = '<div class="time-marker" id="time-marker"></div>';
            timerElement.textContent = '00:00 / 01:00';
            recordingDuration = 0;
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–ø–∏—Å–∏
            recordingTimer = setInterval(updateRecordingTimer, 100);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–ø–∏—Å–∏
        function stopRecording() {
            isRecording = false;
            isWaitingForFirstChord = false;
            recordBtn.textContent = '–ó–∞–ø–∏—Å—å';
            recordBtn.classList.remove('active');
            clearInterval(recordingTimer);
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è, –µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø–∏—Å–∞–Ω–Ω—ã–µ –∞–∫–∫–æ—Ä–¥—ã
            if (recordedSequence.length > 0) {
                playStopBtn.disabled = false;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–∏—Å–∏ –∞–∫–∫–æ—Ä–¥–∞ –≤ —Å–µ–∫–≤–µ–Ω—Å–æ—Ä
        function recordChord(note, chordType) {
            // –ï—Å–ª–∏ –º—ã –∂–¥–µ–º –ø–µ—Ä–≤–æ–≥–æ –∞–∫–∫–æ—Ä–¥–∞, –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–ø–∏—Å—å
            if (isWaitingForFirstChord && !isRecording) {
                isRecording = true;
                recordingStartTime = Date.now();
                recordBtn.textContent = '–°—Ç–æ–ø';
            }
            
            if (!isRecording) return;
            
            const currentTime = Date.now();
            const timeOffset = currentTime - recordingStartTime;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫–∫–æ—Ä–¥ –≤ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
            recordedSequence.push({
                note: note,
                chordType: chordType,
                timeOffset: timeOffset
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π –±–ª–æ–∫ –≤ —Å–µ–∫–≤–µ–Ω—Å–æ—Ä
            addChordBlockToSequencer(note, chordType);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–∞ –∞–∫–∫–æ—Ä–¥–∞ –≤ –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Å–µ–∫–≤–µ–Ω—Å–æ—Ä
        function addChordBlockToSequencer(note, chordType) {
            const chordBlock = document.createElement('div');
            chordBlock.className = `chord-block ${chordType}`;
            
            sequencerDisplay.appendChild(chordBlock);
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —Å–µ–∫–≤–µ–Ω—Å–æ—Ä –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
            sequencerDisplay.scrollLeft = sequencerDisplay.scrollWidth;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–∞–ø–∏—Å–∞–Ω–Ω–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        function playSequence() {
            if (recordedSequence.length === 0 || isPlaying) return;
            
            isPlaying = true;
            playStopBtn.textContent = '–°—Ç–æ–ø';
            playStopBtn.classList.add('active');
            recordBtn.disabled = true;
            clearBtn.disabled = true;
            
            playStartTime = Date.now();
            timeMarker.style.display = 'block';
            
            // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∫–∞–∂–¥—ã–π –∞–∫–∫–æ—Ä–¥ –≤ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            recordedSequence.forEach((chord, index) => {
                const timeoutId = setTimeout(() => {
                    // –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º –∞–∫–∫–æ—Ä–¥
                    playChordForSequence(chord.note, chord.chordType);
                    
                    // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –±–ª–æ–∫
                    highlightActiveChordBlock(index);
                }, chord.timeOffset);
                
                playTimeouts.push(timeoutId);
            });
            
            // –ó–∞–≤–µ—Ä—à–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∞–∫–∫–æ—Ä–¥–∞
            const totalDuration = recordedSequence[recordedSequence.length - 1].timeOffset + settings.duration * 1000;
            const endTimeoutId = setTimeout(() => {
                stopPlayback();
            }, totalDuration);
            
            playTimeouts.push(endTimeoutId);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏—è –∞–∫–∫–æ—Ä–¥–∞ –≤ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        function playChordForSequence(note, chordType) {
            const rootFreq = noteFrequencies[note];
            
            switch(chordType) {
                case 'major':
                    playChord(getMajorChord(rootFreq), settings.duration, 'major');
                    break;
                case 'minor':
                    playChord(getMinorChord(rootFreq), settings.duration, 'minor');
                    break;
                case 'major7':
                    playChord(getMajor7Chord(rootFreq), settings.duration, 'major7');
                    break;
                case 'minor7':
                    playChord(getMinor7Chord(rootFreq), settings.duration, 'minor7');
                    break;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–ª–æ–∫–∞ –∞–∫–∫–æ—Ä–¥–∞
        function highlightActiveChordBlock(index) {
            // –°–Ω–∏–º–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–æ –≤—Å–µ—Ö –±–ª–æ–∫–æ–≤
            document.querySelectorAll('.chord-block').forEach(block => {
                block.classList.remove('active');
            });
            
            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –±–ª–æ–∫
            const blocks = document.querySelectorAll('.chord-block');
            if (blocks[index]) {
                blocks[index].classList.add('active');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –º–∞—Ä–∫–µ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏
                const blockRect = blocks[index].getBoundingClientRect();
                const displayRect = sequencerDisplay.getBoundingClientRect();
                const relativeLeft = blockRect.left - displayRect.left;
                timeMarker.style.left = `${relativeLeft + blockRect.width/2}px`;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
        function stopPlayback() {
            isPlaying = false;
            playStopBtn.textContent = '–ü—É—Å–∫';
            playStopBtn.classList.remove('active');
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ —Ç–∞–π–º–µ—Ä—ã
            playTimeouts.forEach(timeoutId => {
                clearTimeout(timeoutId);
            });
            playTimeouts = [];
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
            recordBtn.disabled = false;
            clearBtn.disabled = false;
            timeMarker.style.display = 'none';
            
            // –°–Ω–∏–º–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–æ –≤—Å–µ—Ö –±–ª–æ–∫–æ–≤
            document.querySelectorAll('.chord-block').forEach(block => {
                block.classList.remove('active');
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å–µ–∫–≤–µ–Ω—Å–æ—Ä–∞
        function clearSequencer() {
            recordedSequence = [];
            sequencerDisplay.innerHTML = '<div class="time-marker" id="time-marker"></div>';
            playStopBtn.disabled = true;
            playStopBtn.textContent = '–ü—É—Å–∫';
            playStopBtn.classList.remove('active');
            timerElement.textContent = '00:00 / 01:00';
            stopPlayback();
            stopRecording();
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∞–∫–∫–æ—Ä–¥–æ–≤
        document.querySelectorAll('.chord-button').forEach(button => {
            button.addEventListener('click', function() {
                const note = this.textContent;
                let chordType = '';
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∞–∫–∫–æ—Ä–¥–∞ –ø–æ –∫–ª–∞—Å—Å—É –∫–Ω–æ–ø–∫–∏
                if (this.classList.contains('major')) {
                    chordType = 'major';
                } else if (this.classList.contains('minor')) {
                    chordType = 'minor';
                } else if (this.classList.contains('major7')) {
                    chordType = 'major7';
                } else if (this.classList.contains('minor7')) {
                    chordType = 'minor7';
                }
                
                // –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º –∞–∫–∫–æ—Ä–¥
                const rootFreq = noteFrequencies[note];
                
                switch(chordType) {
                    case 'major':
                        playChord(getMajorChord(rootFreq), settings.duration, 'major');
                        break;
                    case 'minor':
                        playChord(getMinorChord(rootFreq), settings.duration, 'minor');
                        break;
                    case 'major7':
                        playChord(getMajor7Chord(rootFreq), settings.duration, 'major7');
                        break;
                    case 'minor7':
                        playChord(getMinor7Chord(rootFreq), settings.duration, 'minor7');
                        break;
                }
                
                // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∞–∫–∫–æ—Ä–¥, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º –∑–∞–ø–∏—Å–∏
                recordChord(note, chordType);
            });
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Å–µ–∫–≤–µ–Ω—Å–æ—Ä–∞
        recordBtn.addEventListener('click', function() {
            if (isRecording || isWaitingForFirstChord) {
                stopRecording();
            } else {
                startRecording();
            }
        });
        
        playStopBtn.addEventListener('click', function() {
            if (isPlaying) {
                stopPlayback();
            } else {
                playSequence();
            }
        });
        
        clearBtn.addEventListener('click', function() {
            clearSequencer();
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
        downloadBtn.addEventListener('click', function() {
            renderToWAV();
        });
        
        shareBtn.addEventListener('click', function() {
            if (!currentUser) {
                authModal.style.display = 'flex';
                return;
            }
            
            if (recordedSequence.length === 0) {
                alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø–∏—à–∏—Ç–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–∫–∫–æ—Ä–¥–æ–≤');
                return;
            }
            
            shareModal.style.display = 'flex';
        });
        
        galleryBtn.addEventListener('click', function() {
            galleryModal.style.display = 'flex';
            loadGallery();
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
        authBtn.addEventListener('click', function() {
            if (currentUser) {
                signOut();
            } else {
                authModal.style.display = 'flex';
            }
        });
        
        closeAuthBtn.addEventListener('click', function() {
            authModal.style.display = 'none';
        });
        
        loginBtn.addEventListener('click', async function() {
            const email = authEmail.value;
            const password = authPassword.value;
            
            if (!email || !password) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            
            await signIn(email, password);
        });
        
        registerBtn.addEventListener('click', async function() {
            const email = authEmail.value;
            const password = authPassword.value;
            
            if (!email || !password) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            
            if (password.length < 6) {
                alert('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤');
                return;
            }
            
            await signUp(email, password);
        });
        
        closeShareBtn.addEventListener('click', function() {
            shareModal.style.display = 'none';
        });
        
        saveSequenceBtn.addEventListener('click', async function() {
            const title = sequenceTitle.value.trim();
            
            if (!title) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–µ–∫–≤–µ–Ω—Ü–∏–∏');
                return;
            }
            
            await saveSequence(title);
        });
        
        closeGalleryBtn.addEventListener('click', function() {
            galleryModal.style.display = 'none';
        });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
        window.addEventListener('click', function(event) {
            if (event.target === authModal) {
                authModal.style.display = 'none';
            }
            if (event.target === shareModal) {
                shareModal.style.display = 'none';
            }
            if (event.target === galleryModal) {
                galleryModal.style.display = 'none';
            }
        });
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª–∞–π–¥–µ—Ä–æ–≤
        const durationSlider = document.getElementById('duration');
        const reverbSlider = document.getElementById('reverb');
        const brightnessSlider = document.getElementById('brightness');
        const detuneSlider = document.getElementById('detune');
        const pitchSlider = document.getElementById('pitch');
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π —Å–ª–∞–π–¥–µ—Ä–æ–≤
        durationSlider.addEventListener('input', function() {
            settings.duration = this.value / 10;
            document.getElementById('duration-value').textContent = settings.duration.toFixed(1) + '—Å';
        });
        
        reverbSlider.addEventListener('input', function() {
            settings.reverb = this.value / 100;
            document.getElementById('reverb-value').textContent = this.value + '%';
        });
        
        brightnessSlider.addEventListener('input', function() {
            settings.brightness = this.value / 100;
            document.getElementById('brightness-value').textContent = this.value + '%';
        });
        
        detuneSlider.addEventListener('input', function() {
            settings.detune = this.value;
            document.getElementById('detune-value').textContent = this.value + '—Ü';
        });
        
        pitchSlider.addEventListener('input', function() {
            settings.pitch = this.value;
            document.getElementById('pitch-value').textContent = this.value + '—Ü';
        });
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—ã–±–æ—Ä–∞ –≤–æ–ª–Ω—ã
        document.querySelectorAll('.waveform-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.waveform-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                settings.waveform = this.dataset.wave;
            });
        });
        
        // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∞—É–¥–∏–æ–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∫–ª–∏–∫–µ (—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö)
        document.body.addEventListener('click', function() {
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }, { once: true });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–≤–µ—Ä–±–µ—Ä–∞—Ü–∏—é
        convolver.buffer = createReverbBuffer(audioContext, 2.0);
    </script>
</body>
</html>